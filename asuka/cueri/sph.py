from __future__ import annotations

from functools import lru_cache

import numpy as np

from .cart import ncart


def nsph(l: int) -> int:
    """Number of real spherical components for angular momentum l."""
    if l < 0:
        raise ValueError("l must be >= 0")
    return 2 * l + 1

_CART2SPH_SP: dict[int, np.ndarray] = {
    0: np.asarray([[1.0]], dtype=np.float64),
    1: np.asarray([[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], dtype=np.float64),
    2: np.asarray(
        [
            [0.0, 0.0, -0.31539156525252, 0.0, 0.5462742152960396],
            [1.0925484305920792, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 1.0925484305920792, 0.0],
            [0.0, 0.0, -0.31539156525252, 0.0, -0.5462742152960396],
            [0.0, 1.0925484305920792, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.63078313050504, 0.0, 0.0],
        ],
        dtype=np.float64,
    ),
    3: np.asarray(
        [
            [0.0, 0.0, 0.0, 0.0, -0.4570457994644657, 0.0, 0.5900435899266435],
            [1.7701307697799304, 0.0, -0.4570457994644657, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, -1.1195289977703462, 0.0, 1.4453057213202771, 0.0],
            [0.0, 0.0, 0.0, 0.0, -0.4570457994644657, 0.0, -1.7701307697799304],
            [0.0, 2.8906114426405543, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 1.8281831978578629, 0.0, 0.0],
            [-0.5900435899266435, 0.0, -0.4570457994644657, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, -1.1195289977703462, 0.0, -1.4453057213202771, 0.0],
            [0.0, 0.0, 1.8281831978578629, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.7463526651802308, 0.0, 0.0, 0.0],
        ],
        dtype=np.float64,
    ),
    4: np.asarray(
        [
            [0.0, 0.0, 0.0, 0.0, 0.31735664074561293, 0.0, -0.47308734787878, 0.0, 0.6258357354491761],
            [2.5033429417967046, 0.0, -0.94617469575756, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, -2.0071396306718676, 0.0, 1.7701307697799304, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.6347132814912259, 0.0, 0.0, 0.0, -3.755014412695057],
            [0.0, 5.310392309339791, 0.0, -2.0071396306718676, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, -2.5388531259649034, 0.0, 2.8385240872726802, 0.0, 0.0],
            [-2.5033429417967046, 0.0, -0.94617469575756, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, -2.0071396306718676, 0.0, -5.310392309339791, 0.0],
            [0.0, 0.0, 5.6770481745453605, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 2.676186174229157, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.31735664074561293, 0.0, 0.47308734787878, 0.0, 0.6258357354491761],
            [0.0, -1.7701307697799304, 0.0, -2.0071396306718676, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, -2.5388531259649034, 0.0, -2.8385240872726802, 0.0, 0.0],
            [0.0, 0.0, 0.0, 2.676186174229157, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.8462843753216345, 0.0, 0.0, 0.0, 0.0],
        ],
        dtype=np.float64,
    ),
    5: np.asarray(
        [
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.45294665119569694, 0.0, -0.4892382994352504, 0.0, 0.6563820568401701],
            [3.2819102842008507, 0.0, -1.467714898305751, 0.0, 0.45294665119569694, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 1.754254836801354, 0.0, -2.396768392486662, 0.0, 2.075662314881041, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9058933023913939, 0.0, 0.9784765988705008, 0.0, -6.563820568401701],
            [0.0, 8.302649259524165, 0.0, -4.793536784973324, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -5.435359814348363, 0.0, 3.913906395482003, 0.0, 0.0],
            [-6.563820568401701, 0.0, -0.9784765988705008, 0.0, 0.9058933023913939, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 3.508509673602708, 0.0, 0.0, 0.0, -12.453973889286248, 0.0],
            [0.0, 0.0, 11.741719186446009, 0.0, -5.435359814348363, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, -4.678012898136944, 0.0, 4.793536784973324, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.45294665119569694, 0.0, 1.467714898305751, 0.0, 3.2819102842008507],
            [0.0, -8.302649259524165, 0.0, -4.793536784973324, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -5.435359814348363, 0.0, -11.741719186446009, 0.0, 0.0],
            [0.0, 0.0, 0.0, 9.587073569946648, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 3.6235732095655755, 0.0, 0.0, 0.0, 0.0],
            [0.6563820568401701, 0.0, 0.4892382994352504, 0.0, 0.45294665119569694, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 1.754254836801354, 0.0, 2.396768392486662, 0.0, 2.075662314881041, 0.0],
            [0.0, 0.0, -3.913906395482003, 0.0, -5.435359814348363, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, -4.678012898136944, 0.0, -4.793536784973324, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 3.6235732095655755, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.0, 0.0, 0.0, 0.0, 0.0, 0.9356025796273888, 0.0, 0.0, 0.0, 0.0, 0.0],
        ],
        dtype=np.float64,
    ),
}


@lru_cache(maxsize=None)
def cart2sph_matrix(l: int) -> np.ndarray:
    """Return the (ncart, nsph) Cartesianâ†’spherical transform matrix (PySCF convention, normalized='sp')."""
    if l < 0:
        raise ValueError("l must be >= 0")
    mat = _CART2SPH_SP.get(l)
    if mat is None:
        raise NotImplementedError(f"cart2sph_matrix is only implemented for l<=5 (got l={l})")
    # Basic shape sanity.
    if mat.shape != (ncart(l), nsph(l)):  # pragma: no cover (guard)
        raise RuntimeError(f"cart2sph_matrix has unexpected shape {mat.shape} for l={l}")
    return mat


__all__ = ["cart2sph_matrix", "nsph"]
